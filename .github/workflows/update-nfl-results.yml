name: Update NFL Game Results

on:
  schedule:
    # Thursday Night Football: 8 PM - 1 AM ET (1-6 AM UTC Friday)
    - cron: '0 1-6 * 9-12,1 5'

    # Sunday Early Games: 1 PM - 5 PM ET (6-10 PM UTC Sunday)
    - cron: '0 18-22 * 9-12,1 0'

    # Sunday Late Games & Night: 5 PM - 1 AM ET (10 PM UTC Sun - 6 AM UTC Mon)
    - cron: '0 22-23 * 9-12,1 0'
    - cron: '0 0-6 * 9-12,1 1'

    # Monday Night Football: 8 PM - 1 AM ET (1-6 AM UTC Tuesday)
    - cron: '0 1-6 * 9-12,1 2'

  # Allow manual trigger from GitHub Actions tab
  workflow_dispatch:
    inputs:
      week:
        description: 'Week number (optional - auto-detects if not provided)'
        required: false
        type: string

jobs:
  update-results:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm install @supabase/supabase-js

      - name: Validate secrets
        run: |
          if [ -z "${{ secrets.SUPABASE_URL }}" ]; then
            echo "ERROR: SUPABASE_URL secret is not set"
            exit 1
          fi

          if [ -z "${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}" ]; then
            echo "ERROR: SUPABASE_SERVICE_ROLE_KEY secret is not set"
            exit 1
          fi

          echo "✓ All secrets are configured"

      - name: Update NFL Game Results
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          WEEK: ${{ github.event.inputs.week }}
        run: |
          node -e "
          const { createClient } = require('@supabase/supabase-js');

          const supabase = createClient(
            process.env.SUPABASE_URL,
            process.env.SUPABASE_SERVICE_ROLE_KEY
          );

          const week = process.env.WEEK || '';
          const functionName = 'update-nfl-results';
          const params = week ? { week: week } : {};

          console.log('Calling Edge Function:', functionName);
          if (week) console.log('Using specified week:', week);
          else console.log('Auto-detecting current week');

          supabase.functions
            .invoke(functionName, { body: params })
            .then(({ data, error }) => {
              if (error) {
                console.error('ERROR:', error.message);
                process.exit(1);
              }
              console.log('✓ Update successful');
              console.log('Response:', JSON.stringify(data, null, 2));
            })
            .catch(err => {
              console.error('ERROR:', err.message);
              process.exit(1);
            });
          "


      - name: Log completion
        run: echo "NFL results update completed"
